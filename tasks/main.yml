---

- name: Prevent AAW from strpping characters out of account or project file names.
  fail:
    msg: The combination of linunx_owner + project name cannot exceed 16 characters.
  when: "((linux_owner|length + project|length) > 16)
    and (force == false)"

- name: Prevent AAW from clipping php service user account names
  fail:
    msg: The length of 'linunx_owner' cannot exceed 12 characters.
  when: "(php_service_user == '')
    and (linux_owner|length > 12)
    and (force == false)"

# We need to set facts here using internal names, as opposed to the ones we told the role consumer about, because:
# 1: This role is meant to be used multiple times in the same playbook,
# 2: Ansible is basically scopeless; everything is global
# 3: Once we set a fact in a role, it overrides the role's "defaults" the next time the role is used.
# 4: We need to provide a way for the consumer to override defaults, without imposing variable bleed across multiple uses
- name: (Re)set some runtime variables for the role's internal use
  set_fact:
    skip_ssl_flag: ''
    rds_flag: ''
    force_flag: ''
    service_account_flag: ''
    x__php_service_user: ''
    x__fpm_pool_filename: ''

- set_fact:
    skip_ssl_flag: '--skip-ssl'
  when: "ssl == 'none'"

- set_fact:
    rds_flag: '--rds'
  when: "rds == true"

- set_fact:
    x__fpm_pool_filename: "{{ project }}.conf"
  when: "fpm_pool_filename == ''
    and project == linux_owner"

- set_fact:
    x__fpm_pool_filename: "{{ linux_owner }}-{{ project }}.conf"
  when: "fpm_pool_filename == ''
    and project != linux_owner"

- set_fact:
    x__php_service_user: "{{ project }}-srv"
  when: "php_service_user == ''
    and project == linux_owner"

- set_fact:
    x__php_service_user: "{{ linux_owner }}-{{ project }}-srv"
  when: "php_service_user == ''
    and project != linux_owner"

- set_fact:
    x__php_service_user: "{{ php_service_user }}"
  when: "php_service_user != ''"

- set_fact:
    service_account_flag: '--service-account {{ x__php_service_user }}'
  when: "x__php_service_user != ''"

- set_fact:
    force_flag: '--force'
  when: "force == true"

- name: Run acro-add-website
  shell: >
     export TERM=xterm-256color; /usr/bin/timeout 30s /bin/bash /usr/local/sbin/acro-add-website.sh --account {{ linux_owner }} --project {{ project }} --fqdn {{ nginx_primal_name }} --webroot {{ web_root_dir_name }} --php-version {{ php_version }} --responsible-person {{ responsible_person }} --mysql-allow-from {{ mysql_allow_from }} --mysql-host-address {{ mysql_host_address }} {{ skip_ssl_flag }} {{ rds_flag }} {{ service_account_flag }} {{ force_flag}}
  args:
    creates: /home/{{ linux_owner }}/.acro-add-website/{{ project }}

- name: Try and expand the primal name's Certificate to include nginx aliases and canonical name. If DNS is pointing at the machine for these names, the command will work.
#    /usr/local/bin/certbot-auto --no-self-upgrade certonly --non-interactive --webroot --agree-tos -w /var/www/letsencrypt  --email webmaster@acromedia.com --cert-name {{ nginx_primal_name }} --keep -d "{{ nginx_canonical_name }},{{ nginx_aliases |join(',') }},{{ nginx_primal_name }}"
  script:  scripts/certbot-wrapper
  args:
    executable: /bin/bash
  environment:
    INVENTORY_HOSTNAME: "{{ inventory_hostname }}"
    NGINX_PRIMAL_NAME: "{{ nginx_primal_name }}"
    NGINX_CANONICAL_NAME: "{{ nginx_canonical_name }}"
    NGINX_ALIASES: "{{ nginx_aliases |join(',') }}"
  when: deploy_env == 'production'
    and ssl == 'letsencrypt'
  register: letsencrypt_result
  ignore_errors: true

- name: Upload arbitrary customizations for the virtual host
  template:
    src: "{{ nginx_include_custom }}"
    dest: /etc/nginx/includes/{{ nginx_primal_name }}.customizations.conf
    owner: root
    group: root
    mode: 0644
    backup: true
  notify: arvh safe reload nginx
  when: "nginx_include_custom | trim() != ''"

- name: Update PHP FPM nginx include for {{ nginx_primal_name }}
  template:
    src: "{{ role_path }}/templates/etc/nginx/includes/ACCOUNT-PROJECT.php-fpm.conf.j2"
    dest: "{{ path_to_nginx_php_fpm_include }}"
    backup: true
  notify:
    - arvh safe reload nginx

- name: Update nginx virtual host configuration for {{ nginx_primal_name }}
  template:
    src: "{{ role_path }}/templates/etc/nginx/sites-available/{{ deploy_env }}.{{ ssl }}.conf.j2"
    dest: /etc/nginx/sites-available/{{ nginx_primal_name }}
    backup: true
  notify:
    - arvh safe reload nginx

- name: Enable (symlink) nginx virtual host configuration for {{ nginx_primal_name }}
  file:
    src: "/etc/nginx/sites-available/{{ nginx_primal_name }}"
    dest: "/etc/nginx/sites-enabled/{{ nginx_primal_name }}"
    state: link
  notify:
    - arvh safe reload nginx

- name: Update PHP {{ php_version }} FPM pool for {{ linux_owner }}/{{ project }}
  template:
    src: "{{ role_path }}/templates/etc/php/VERSION/fpm/pool.d/ACCOUNT-PROJECT.conf.j2"
    dest: /etc/php/{{ php_version }}/fpm/pool.d/{{ x__fpm_pool_filename }}
    backup: true
  notify:
    - restart php{{ php_version }}-fpm

- name: Construct a list of notifies to use when changing a pool between PHP versions
  shell: >
    /usr/bin/dpkg --list|/bin/grep -woE '\bphp.*-fpm\b'|/usr/bin/awk '{print "restart " $1}'
  register: cmdresult_php_notify_list
  changed_when: false

- name: Enumerate /etc/php/VERSION/fpm/pool.d directories that are not "{{ php_version }}", used by the 'remove' task below)
  shell: >
    /usr/bin/find /etc/php -maxdepth 3 -type d -path '/etc/php/*/fpm/pool.d' | /usr/bin/cut -d'/' -f 4 | (grep -v "{{ php_version }}" || true)
  register: cmdresult_enumerate_php_version_numbers
  changed_when: false

- name: Remove all FPM pools that are not PHP {{ php_version }} for {{ linux_owner }}/{{ project }}
  file:
    path: /etc/php/{{ item }}/fpm/pool.d/{{ linux_owner }}-{{ project }}.conf
    state: absent
  with_items:
    - "{{ cmdresult_enumerate_php_version_numbers.stdout_lines|default([]) }}"
  notify: "{{ cmdresult_php_notify_list.stdout_lines|default([]) }}"

- name: Install dependency for htpasswd operations
  apt:
    name: python-passlib
    state: present
    update_cache: true
  when: require_http_auth == true

- name: Create htpasswd file for {{ linux_owner }}-{{ project }}
  htpasswd:
    path: "{{ path_to_htpasswd_file }}"
    name: "{{ http_auth_username }}"
    password: "{{ http_auth_password }}"
    owner: root
    group: www-data
    mode: 0640
  when: require_http_auth == true
  notify:
    - arvh safe reload nginx
